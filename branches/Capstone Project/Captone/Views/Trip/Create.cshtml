@model Captone.Models.Trip
<script src="~/Content/ui/jquery-ui.js" type="text/javascript"></script>
<link rel="stylesheet" href="~/Content/themes/base/jquery-ui.css" />
@{
    //ViewBag.Title = "Thêm chuyến mới";
    //Layout = "~/Views/Shared/_LayoutStaff.cshtml";
    Layout = null;
}

<div class="row">
    <div class="col-md-6">
        @using (Html.BeginForm())
        {
            @Html.ValidationSummary(true)

            <strong>Ngày chạy
            </strong>
            <div class="editor-field">
                <input type="text" id="datepicker" name="Date" class="form-control"/>
            </div>
            <br />
            <strong>Tuyến
            </strong>
            <div class="editor-field" id="change">
                @Html.DropDownList("RouteID", ViewData["RouteID"] as List<SelectListItem>)
                @Html.ValidationMessageFor(model => model.Schedule.Coach.NumberPlate)
            </div>
            <br />
            <p>
                <button type="submit" class="btn btn-primary" onclick="SentObject()">Tạo mới</button>
                <button type="button" class="btn btn-info" data-dismiss="modal">Hủy</button>
            </p>
        }
    </div>
    <div class="col-md-6">
        <div id="samedateTrip"></div>
    </div>
</div>
<div class="row">
    <div class="col-md-8">
        <div id="schedule"></div>
    </div>
</div>


<script type="text/javascript">
    window.onload = initialize();

    function initialize() {
        $("input").addClass("form-control");
        $("select").addClass("form-control");
        document.getElementById("change").selectedIndex = -1;
        DatePicker();
    }

    function listTrip(value) {
        $.ajax({
            url: "/Trip/ListTrip",
            type: "POST",
            data: { tripDate: value },
            success: function (result) {
                $("#samedateTrip").html(result);
            }
        });
    }

    function listOnRoute(route) {
        $.ajax({
            url: "/Schedule/SchedulePartialView",
            type: "Post",
            data: { routeID: route },
            success: function (result) {
                $("#schedule").html(result);
            }
        });
    }

    $('#RouteID').on('change', function () {
        listOnRoute($('#RouteID').val());
    });

    function DatePicker() {
        $("#datepicker").datepicker({ dateFormat: "yy/mm/dd" });
    };

    // Get schedule objects
    function getScheduleObject() {
        var schedules = [];
        $('[name="1"]:checked').each(function () {
            var row = $(this).closest('tr');
            var sch = {
                ScheduleID: row.find('td:nth-child(2)').text(),
                RouteID: $('#RouteID').val(),
                CoachID: row.find('td:nth-child(4)').text(),
                EstimateDepartureTime: row.find('td:nth-child(7)').text(),
                EstimateVolume: row.find('td:nth-child(9)').text() * row.find('td:nth-child(10)').text()
            };
            // Push schedule object to collection
            schedules.push(sch);
        });
        return schedules;
    }

    // Sent schedule objects to controller
    function SentObject() {
        var schedules = getScheduleObject();
        var date = $('#datepicker').val();
        $.ajax({
            url: "/Trip/Create",
            type: "POST",
            data: JSON.stringify({ schedules: schedules, date: date }),
            contentType: "application/json",
            dataType: "json",
            success: function (result) {
            }
        });
    }
</script>
